<div class="livraison-container">
  <div class="header">
    <h2>Deliveries Management</h2>
    <button *ngIf="authService.isAdmin()" class="btn btn-primary" (click)="openCreateModal()">
      + Add Delivery
    </button>
  </div>

  <div class="search-bar">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      (input)="searchLivraisons()"
      placeholder="Search deliveries by person or status..."
      class="search-input"
    />
  </div>

  <div *ngIf="error" class="alert alert-error">{{ error }}</div>
  <div *ngIf="loading" class="loading">Loading deliveries...</div>

  <div *ngIf="!loading && filteredLivraisons.length === 0" class="no-data">
    No deliveries found.
  </div>

  <div
    *ngIf="!loading && filteredLivraisons.length > 0"
    class="table-container"
  >
    <table>
      <thead>
        <tr>
          <th>Client</th>
          <th>Order Date</th>
          <th>Delivery Person</th>
          <th>Delivery Date</th>
          <th>Payment Mode</th>
          <th>Status</th>
          <th *ngIf="authService.isAdmin()">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let livraison of filteredLivraisons">
          <td>{{ livraison.clientName || 'N/A' }}</td>
          <td>{{ livraison.commandeDate | date : "short" }}</td>
          <td>{{ livraison.deliveryPerson }}</td>
          <td>{{ livraison.deliveryDate | date : "short" }}</td>
          <td>{{ livraison.paymentMode }}</td>
          <td>
            <span
              class="status-badge"
              [ngClass]="getStatusClass(livraison.status)"
            >
              {{ livraison.status }}
            </span>
          </td>
          <td *ngIf="authService.isAdmin()">
            <div class="actions">
              <button
                class="btn btn-warning"
                (click)="openEditModal(livraison)"
              >
                Edit
              </button>
              <button
                class="btn btn-danger"
                (click)="deleteLivraison(livraison._id)"
              >
                Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div *ngIf="showModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ editMode ? "Edit Delivery" : "Add New Delivery" }}</h3>
      <span class="close" (click)="closeModal()">&times;</span>
    </div>

    <form (ngSubmit)="saveLivraison()">
      <div class="form-group">
        <label for="commandId">Order *</label>
        <select
          id="commandId"
          [(ngModel)]="currentLivraison.commandId"
          name="commandId"
          required
        >
          <option value="">Select an order</option>
          <option *ngFor="let commande of commandes" [value]="commande._id">
            Order #{{ commande._id }} - {{ commande.client }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="delivererId">Delivery Person *</label>
        <select
          id="delivererId"
          [(ngModel)]="currentLivraison.delivererId"
          name="delivererId"
          (change)="onDelivererChange()"
          required
        >
          <option value="">Select a deliverer</option>
          <option *ngFor="let person of personnel" [value]="person._id">
            {{ person.nom }} {{ person.prenom }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="deliveryDate">Delivery Date *</label>
        <input
          type="date"
          id="deliveryDate"
          [ngModel]="currentLivraison.deliveryDate | date : 'yyyy-MM-dd'"
          (ngModelChange)="currentLivraison.deliveryDate = $event"
          name="deliveryDate"
          required
        />
      </div>

      <div class="form-group">
        <label for="paymentMode">Payment Mode *</label>
        <select
          id="paymentMode"
          [(ngModel)]="currentLivraison.paymentMode"
          name="paymentMode"
          required
        >
          <option value="">Select payment mode</option>
          <option value="cash">Cash</option>
          <option value="card">Card</option>
          <option value="online">Online</option>
        </select>
      </div>

      <div class="form-group">
        <label for="status">Status *</label>
        <select
          id="status"
          [(ngModel)]="currentLivraison.status"
          name="status"
          required
        >
          <option value="en attente">En attente</option>
          <option value="en cours">En cours</option>
          <option value="livrée">Livrée</option>
          <option value="annulée">Annulée</option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-success">
          {{ editMode ? "Update" : "Create" }}
        </button>
      </div>
    </form>
  </div>
</div>


